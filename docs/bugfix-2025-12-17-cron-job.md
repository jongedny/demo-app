# Bug Fix: Daily Events Cron Job Not Generating Events

**Date:** December 17, 2025  
**Issue:** No events were generated by OpenAI since December 16th deployment  
**Status:** âœ… Fixed and deployed

## Problem Description

After changes were committed and deployed to production on December 16th, the daily cron job stopped generating events. The cron job runs at 6 AM daily but no events were being created for December 17th.

## Root Cause

The OpenAI prompt configuration in `src/server/config/prompts.ts` was missing the `date` field in the response format specification. 

### What Happened:

1. The `dailyEvents.userPrompt` asked OpenAI to provide:
   - `name`
   - `keywords`
   - `description`
   
2. However, the validation logic in `src/server/services/openai.ts` (lines 66-78) expected each event to also have a `date` field:
   ```typescript
   typeof event.date === "string" && event.date.length > 0
   ```

3. Since OpenAI wasn't instructed to include the `date` field, it didn't provide it in the response.

4. All events were filtered out as invalid during validation, resulting in an empty array.

5. The cron job completed successfully but with "No events to save".

## The Fix

Updated `src/server/config/prompts.ts` to include the `date` field requirement:

**Before:**
```typescript
For each event, provide:
1. name: The event name
2. keywords: An array of 3-5 relevant keywords related to the event
3. description: A brief description of the event (maximum 200 words)

Please respond with ONLY a JSON array of objects in this exact format:
[
  {
    "name": "Event Name 1",
    "keywords": ["keyword1", "keyword2", "keyword3"],
    "description": "A brief description of the event..."
  }
]
```

**After:**
```typescript
For each event, provide:
1. name: The event name
2. keywords: An array of 3-5 relevant keywords related to the event
3. description: A brief description of the event (maximum 200 words)
4. date: The date in ISO format (YYYY-MM-DD)

Please respond with ONLY a JSON array of objects in this exact format:
[
  {
    "name": "Event Name 1",
    "keywords": ["keyword1", "keyword2", "keyword3"],
    "description": "A brief description of the event...",
    "date": "2025-12-17"
  }
]
```

## Testing

Tested locally using:
```bash
curl -X GET "http://localhost:3000/api/cron/daily-events?secret=dev-cron-secret-2025"
```

**Result:** Successfully generated 4 events with all required fields including the `date` field.

## Deployment

- **Initial Fix Commit:** e2deb03
- **Year Correction Commit:** 69f770c
- **Pushed to:** GitHub main branch
- **Deployment:** Automatic via Vercel
- **Next Cron Run:** Tomorrow at 6 AM (will generate events for December 18th)

## Additional Improvement: Year Correction

After the initial fix, we discovered that OpenAI was returning dates with the year 2023 instead of 2025. We added additional logic to correct this:

**Added in `src/server/services/openai.ts`:**
```typescript
.map((event) => {
    // Correct the year in the date to use the current year
    // OpenAI sometimes returns incorrect years, so we replace it with the current year
    const currentYear = today.getFullYear();
    const dateParts = event.date.split('-');
    if (dateParts.length === 3) {
        dateParts[0] = currentYear.toString();
        event.date = dateParts.join('-');
    }
    return event;
})
```

This ensures all events are saved with the correct year in the database.

## Prevention

To prevent similar issues in the future:

1. **Always sync prompt requirements with validation logic** - When updating validation, ensure prompts are updated accordingly
2. **Add integration tests** - Consider adding tests that validate the full cron job flow
3. **Monitor cron job outputs** - Set up alerts for when cron jobs complete with 0 events saved

## Related Files

- `src/server/config/prompts.ts` - OpenAI prompt configuration
- `src/server/services/openai.ts` - OpenAI service with validation logic
- `src/app/api/cron/daily-events/route.ts` - Cron job endpoint
- `vercel.json` - Cron job schedule configuration
